<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Live Labour Strikes Map — Debugging Build</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.css" rel="stylesheet"/>
  <style>
    body { margin:0; padding:0; font-family:system-ui,Segoe UI,Roboto,sans-serif; }
    #map { position:absolute; top:220px; bottom:0; width:100%; transition:top 0.3s ease; }
    #header {
      position:absolute; top:0; left:0; right:0;
      background:#222; color:white; padding:12px 18px;
      z-index:1000; display:flex; flex-direction:column; align-items:center;
      height:220px; overflow:hidden; transition:transform 0.3s ease;
    }
    .title { font-size:22px; font-weight:700; margin-bottom:8px; text-align:center; }
    .metrics-container{display:flex;flex-wrap:wrap;justify-content:center;gap:28px;max-width:1100px}
    .metric{ text-align:center }
    .metric-label{ font-size:13px; text-transform:uppercase; font-weight:700; color:#ddd }
    .metric-value{ font-size:18px; color:#6ef06e; margin-top:4px }
    .nationwide-container{ display:flex; gap:28px; margin-top:10px; justify-content:center }
    .nationwide-label{ font-size:13px; font-weight:700; color:#ffd57a }
    .nationwide-value{ font-size:16px; color:#ffd57a; margin-top:4px }
    #toggle-header{ position:absolute; bottom:10px; left:50%; transform:translateX(-50%); background:none; border:none; color:white; font-size:22px; cursor:pointer }
    .legend{ position:absolute; bottom:20px; right:20px; background:white; padding:10px; border-radius:6px; font-size:12px }
    .legend span{ display:inline-block; width:12px; height:12px; margin-right:6px }
    /* debug panel */
    #debug {
      position:fixed; left:10px; bottom:10px; width:420px; max-height:45vh; overflow:auto;
      background:rgba(12,12,12,0.92); color:#e6ffee; padding:10px; z-index:2000; font-family:monospace; font-size:12px; border-radius:6px;
      box-shadow:0 6px 18px rgba(0,0,0,0.6);
    }
    #debug h4{ margin:0 0 6px 0; font-size:13px; color:#ffd57a }
    #debug pre{ white-space:pre-wrap; word-break:break-word; max-height:30vh; overflow:auto; margin:6px 0; background:rgba(0,0,0,0.2); padding:8px; border-radius:4px }
    #debug .btn { display:inline-block; padding:6px 8px; background:#2a2a2a; color:#fff; border-radius:4px; cursor:pointer; margin-right:6px; font-size:12px; }
    #refresh { position: absolute; top:10px; right:10px; z-index:1200; padding:6px 10px; border-radius:6px; background:#1e90ff; color:white; border:none; cursor:pointer; }
  </style>
</head>
<body>
  <div id="header">
    <div class="title">Live Labour Strikes Map</div>

    <div class="metrics-container" id="metrics">
      <div class="metric"><div class="metric-label">Productivity Growth %</div><div class="metric-value" id="prod">—</div></div>
      <div class="metric"><div class="metric-label">Business Closings %</div><div class="metric-value" id="close">—</div></div>
      <div class="metric"><div class="metric-label">Confidence Index</div><div class="metric-value" id="conf">—</div></div>
      <div class="metric"><div class="metric-label">Inflation %</div><div class="metric-value" id="infl">—</div></div>
      <div class="metric"><div class="metric-label">Wage Growth (avg $)</div><div class="metric-value" id="wage">—</div></div>
    </div>

    <div class="nationwide-container">
      <div class="nationwide"><div class="nationwide-label">Nationwide Strikers</div><div class="nationwide-value" id="nat-strikers">—</div></div>
      <div class="nationwide"><div class="nationwide-label">Strike % of Population</div><div class="nationwide-value" id="nat-percent">—</div></div>
      <div class="nationwide"><div class="nationwide-label">Wage Demand ($)</div><div class="nationwide-value" id="nat-wage">—</div></div>
    </div>

    <button id="toggle-header" title="Toggle header visibility">▲</button>
  </div>

  <button id="refresh" title="Refresh data">Refresh</button>

  <div id="map"></div>

  <div class="legend">
    <div><span style="background:#cccccc"></span>No strikes</div>
    <div><span style="background:#f4a6a6"></span>Low strike %</div>
    <div><span style="background:#d12c0f"></span>High strike %</div>
  </div>

  <!-- Debug panel -->
  <div id="debug">
    <h4>Data fetch debug</h4>
    <div>
      <span class="btn" id="btn-fetch">Fetch now</span>
      <span class="btn" id="btn-clear">Clear</span>
    </div>
    <div><strong>Status:</strong> <span id="dbg-status">idle</span></div>
    <div><strong>Raw response (first 20k chars):</strong><pre id="raw">—</pre></div>
    <div><strong>Parsed JSON preview:</strong><pre id="json">—</pre></div>
    <div><strong>GeoJSON check:</strong><pre id="geo-check">—</pre></div>
    <div><strong>Notes:</strong><pre id="hints">If fetch fails: ensure Apps Script is deployed as Web App with access "Anyone, even anonymous".</pre></div>
  </div>

  <script>
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzSlHgv07HZhfwwXwjkmNpP-4YfY3UNfQzzMojmJg7gHc_WdloJ7bRIp2OcdZPrDJNfKw/exec';
    mapboxgl.accessToken = 'YOUR_MAPBOX_ACCESS_TOKEN';

    const dbgStatus=document.getElementById('dbg-status'),
          rawEl=document.getElementById('raw'),
          jsonEl=document.getElementById('json'),
          geoCheckEl=document.getElementById('geo-check'),
          hintsEl=document.getElementById('hints');

    const btnFetch=document.getElementById('btn-fetch'),
          btnClear=document.getElementById('btn-clear'),
          btnRefresh=document.getElementById('refresh');

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/light-v10',
      center: [-98.5795, 39.8283],
      zoom: 3
    });

    btnFetch.addEventListener('click', fetchAndRender);
    btnClear.addEventListener('click', ()=>{ rawEl.textContent='—'; jsonEl.textContent='—'; geoCheckEl.textContent='—'; dbgStatus.textContent='idle'; });
    btnRefresh.addEventListener('click', fetchAndRender);

    function setStatus(s){ dbgStatus.textContent=s; }
    function showRaw(t){ rawEl.textContent=t.slice(0,20000); }
    function showJSON(o){ jsonEl.textContent=JSON.stringify(o,null,2).slice(0,20000); }
    function showGeo(m){ geoCheckEl.textContent=m; }

    // Normalize region names to uppercase for matching
    function normRegion(str){
      return (str||'').toString().trim().toUpperCase();
    }

    async function fetchAndRender(){
      setStatus('fetching...');
      showRaw('fetching…'); showJSON('—'); showGeo('—');
      try {
        const res = await fetch(APPS_SCRIPT_URL+'?_'+Date.now());
        const text = await res.text();
        showRaw(`HTTP ${res.status} ${res.statusText}\n\n`+text);

        if (text.trim().startsWith('<')) {
          setStatus('failed: HTML returned (not public)');
          return;
        }

        const data=JSON.parse(text);
        showJSON(data);

        const geojson=data.geojson;
        if(!geojson||!geojson.features){setStatus('invalid geojson');return;}
        setStatus('geojson ok — '+geojson.features.length+' features');

        // Fix case-insensitive region matching: copy uppercase name
        geojson.features.forEach(f=>{
          if(f.properties){
            f.properties.region_upper=normRegion(f.properties.region||f.properties.name);
          }
        });

        const sample=geojson.features.slice(0,6).map((f,i)=>`#${i} ${f.properties.region_upper} — ${JSON.stringify(f.properties).slice(0,200)}`).join('\n\n');
        showGeo(sample);

        // Update economic metrics
        (data.economicImpact||[]).forEach(e=>{
          const m=(e.metric||'').toLowerCase();
          if(m.includes('productivity')) document.getElementById('prod').textContent=e.current_value;
          else if(m.includes('closing')) document.getElementById('close').textContent=e.current_value;
          else if(m.includes('confidence')) document.getElementById('conf').textContent=e.current_value;
          else if(m.includes('inflation')) document.getElementById('infl').textContent=e.current_value;
          else if(m.includes('wage')) document.getElementById('wage').textContent=e.current_value;
        });

        // Nationwide update
        const nat=geojson.features.find(f=>normRegion(f.properties.region||f.properties.name)==='NATIONWIDE');
        if(nat&&nat.properties){
          document.getElementById('nat-strikers').textContent=nat.properties.strikers||0;
          document.getElementById('nat-percent').textContent=nat.properties.strike_percent||'0%';
          document.getElementById('nat-wage').textContent=nat.properties.wage_demand||'$0';
        }

        if(map.getSource('regions')) map.getSource('regions').setData(geojson);
        else map.addSource('regions',{type:'geojson',data:geojson});

        if(!map.getLayer('regions-fill')){
          map.addLayer({
            id:'regions-fill',type:'fill',source:'regions',
            paint:{'fill-color':['interpolate',['linear'],['to-number',['get','strike_percent'],0],0,'#ccc',5,'#f4a6a6',15,'#d12c0f'],'fill-opacity':0.7}
          });
        }
        if(!map.getLayer('regions-outline')){
          map.addLayer({id:'regions-outline',type:'line',source:'regions',paint:{'line-color':'#000','line-width':1}});
        }

        const popup=new mapboxgl.Popup({closeButton:false,closeOnClick:false});
        map.on('mousemove','regions-fill',e=>{
          const p=e.features[0].properties;
          popup.setLngLat(e.lngLat).setHTML(`
            <strong>${p.region||p.name}</strong><br/>
            Strikers: ${p.strikers}<br/>
            Strike %: ${p.strike_percent}<br/>
            Population: ${p.population}<br/>
            Output: ${p.adjusted_output}<br/>
            Wage: ${p.wage_demand}<br/>
            Notes: ${p.notes}
          `).addTo(map);
        });
        map.on('mouseleave','regions-fill',()=>popup.remove());
        setStatus('done');
      } catch(err){setStatus('error '+err);}
    }

    map.on('load',fetchAndRender);
  </script>
</body>
</html>
