<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Live Labour Strikes Map</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.css" rel="stylesheet"/>
  <style>
    body { margin:0; padding:0; font-family:Arial, sans-serif; }
    #map { position:absolute; top:0; bottom:0; width:100%; }
    #sidebar {
      position:absolute;
      top:0; left:0;
      margin:12px;
      background:#fff;
      padding:12px;
      border-radius:8px;
      box-shadow:0 2px 6px rgba(0,0,0,0.3);
      z-index:1;
      width:250px;
    }
    #sidebar h2 { margin:0 0 10px 0; font-size:18px; }
    #sidebar p { margin:4px 0; font-size:14px; }
  </style>
</head>
<body>
<div id="map"></div>
<div id="sidebar">
  <h2>Nationwide Strikers</h2>
  <p id="nat-strikers">Loading...</p>
  <h2>Strike % of Population</h2>
  <p id="nat-percent">Loading...</p>
  <h2>Wage Demand ($)</h2>
  <p id="nat-wage">Loading...</p>
</div>
<script>
mapboxgl.accessToken = "YOUR_MAPBOX_ACCESS_TOKEN";

const map = new mapboxgl.Map({
  container: "map",
  style: "mapbox://styles/mapbox/light-v11",
  center: [0,20],
  zoom: 1.2
});

function fmtNumber(v){
  if (v === null || v === undefined || v === "") return "0";
  return Number(v).toLocaleString();
}
function fmtMoney(v){
  if (v === null || v === undefined || v === "") return "$0";
  return "$" + Number(v).toLocaleString();
}
function fmtPercent(v){
  if (v === null || v === undefined || v === "") return "0%";
  const num = Number(String(v).replace("%",""));
  return isNaN(num) ? v : num.toFixed(2) + "%";
}

async function fetchData(){
  try {
    const res = await fetch("YOUR_APPS_SCRIPT_URL");
    const data = await res.json();

    // Normalize regions
    const normalized = data.map(row => ({
      region: row.region,
      population: Number(row.population),
      strikers: Number(row.strikers),
      strike_percent: Number(row.strike_percent),
      baseline_output: Number(row.baseline_output),
      adjusted_output: Number(row.adjusted_output),
      wage_demand: Number(row.wage_demand),
      notes: row.notes,
      sheet: row.sheet
    }));

    // Update nationwide sidebar
    const nationwide = normalized.find(d => d.region === "Nationwide");
    if (nationwide) {
      const sp = Number(nationwide.strike_percent);
      document.getElementById("nat-strikers").textContent = fmtNumber(nationwide.strikers);
      document.getElementById("nat-percent").textContent = fmtPercent(sp);
      document.getElementById("nat-wage").textContent = fmtMoney(nationwide.wage_demand);
    } else {
      console.warn("Nationwide data not found in API response");
    }

    // Regions â†’ GeoJSON features
    const features = normalized
      .filter(r => r.region !== "Nationwide")
      .map(r => ({
        type: "Feature",
        properties: {
          region: r.region,
          strikers: r.strikers,
          strike_percent: r.strike_percent,
          wage_demand: r.wage_demand
        },
        geometry: { type: "Point", coordinates: [Math.random()*360-180, Math.random()*140-70] }
      }));

    const geojson = { type: "FeatureCollection", features };

    // Add map layer if not yet present
    if (!map.getSource("strikes")) {
      map.addSource("strikes", { type:"geojson", data: geojson });
      map.addLayer({
        id:"strike-circles",
        type:"circle",
        source:"strikes",
        paint:{
          "circle-radius": ["interpolate", ["linear"], ["get","strike_percent"], 0,4, 5,20],
          "circle-color": ["interpolate", ["linear"], ["get","strike_percent"], 0,"#2DC4B2", 5,"#3BB3C3", 10,"#669EC4", 20,"#8B88B6", 30,"#A2719B", 40,"#AA5E79"]
        }
      });

      // Tooltip on hover
      const popup = new mapboxgl.Popup({ closeButton:false, closeOnClick:false });
      map.on("mousemove", "strike-circles", e => {
        map.getCanvas().style.cursor = "pointer";
        const f = e.features[0];
        popup.setLngLat(f.geometry.coordinates)
          .setHTML(`<b>${f.properties.region}</b><br>Strikers: ${fmtNumber(f.properties.strikers)}<br>Strike %: ${fmtPercent(f.properties.strike_percent)}<br>Wage Demand: ${fmtMoney(f.properties.wage_demand)}`)
          .addTo(map);
      });
      map.on("mouseleave", "strike-circles", () => {
        map.getCanvas().style.cursor = "";
        popup.remove();
      });
    } else {
      map.getSource("strikes").setData(geojson);
    }
  } catch(err){
    console.error("Error fetching data:", err);
  }
}

map.on("load", () => {
  fetchData();
  setInterval(fetchData, 60000); // refresh every 60s
});
</script>
</body>
</html>
