<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Live Labour Strikes Map</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.css" rel="stylesheet"/>
  <style>
    body { margin:0; padding:0; font-family:Arial, sans-serif; }
    #map { position:absolute; top:0; bottom:0; width:100%; }
    #metrics {
      position:absolute; top:10px; left:10px;
      background:white; padding:10px;
      border-radius:6px; box-shadow:0 0 5px rgba(0,0,0,0.3);
      font-size:13px; z-index:1;
    }
    .legend {
      background:white; padding:8px;
      font-size:12px; font-family:Arial, sans-serif;
      position:absolute; bottom:20px; left:20px;
      border-radius:6px; box-shadow:0 0 4px rgba(0,0,0,0.3);
      max-width:200px;
    }
    .legend h4 { margin:0 0 4px; font-size:14px; }
    .legend div { margin:2px 0; }
    .legend span {
      display:inline-block; width:14px; height:14px;
      margin-right:4px; vertical-align:middle;
    }
    .legend hr { margin:6px 0; }
    .legend h5 { margin:4px 0; font-size:13px; }
  </style>
</head>
<body>
<div id="map"></div>
<div id="metrics"></div>
<div class="legend" id="legend"><h4>Strike % of Population</h4></div>

<script>
mapboxgl.accessToken = "pk.eyJ1IjoiNW00Y2s3NyIsImEiOiJjbWI4eXFqeDkwbzY1MmpwcDFzZDIwMmVqIn0.6JGe7JWhk28z5D3TLIJQwg";

// Flat map, no pitch or bearing
const map = new mapboxgl.Map({
  container: "map",
  style: "mapbox://styles/mapbox/light-v11",
  center: [-98, 39],
  zoom: 3,
  pitch: 0,
  bearing: 0
});

// ---- Helpers ----
function fmtNum(v){ return v ? Number(v).toLocaleString() : '0'; }
function fmtPercent(v){ return v ? (Number(v)*100).toFixed(2)+'%' : '0%'; }
function fmtMoney(v){ return v ? '$'+Number(v).toLocaleString() : '$0'; }

// ---- Load Google Sheet JSON ----
async function loadData() {
  const url = "https://script.google.com/macros/s/AKfycbzSlHgv07HZhfwwXwjkmNpP-4YfY3UNfQzzMojmJg7gHc_WdloJ7bRIp2OcdZPrDJNfKw/exec";
  try {
    const resp = await fetch(url);
    if (!resp.ok) throw new Error(resp.status+" "+resp.statusText);
    return await resp.json();
  } catch (err) {
    console.error("❌ Error fetching data:", err);
    alert("Could not load strike data (check console).");
    return null;
  }
}

map.on("load", async () => {
  const data = await loadData();
  if (!data) return;

  console.log("✅ Data loaded:", data);

  // ---- Metrics ----
  if (data.economicImpact) {
    const mDiv = document.getElementById("metrics");
    mDiv.innerHTML = "";
    data.economicImpact.forEach(m => {
      let val = m.current_value;
      if (/wage/i.test(m.metric)) val = fmtMoney(val);
      else if (/%|growth|inflation|closing|productivity/i.test(m.metric)) val = fmtPercent(val);
      else val = fmtNum(val);
      mDiv.innerHTML += `<div><strong>${m.metric}</strong>: ${val}</div>`;
    });
  }

  // ---- Regions ----
  if (data.geojson) {
    map.addSource("regions",{ type:"geojson", data:data.geojson });

    map.addLayer({
      id:"regions-fill", type:"fill", source:"regions",
      paint:{
        "fill-color":[
          "interpolate", ["linear"], ["*",["get","strike_percent"],100],
          0,"#cccccc", 1,"#f4a6a6", 5,"#ff9966",
          10,"#ff3300", 20,"#b30000", 40,"#660000"
        ],
        "fill-opacity":0.7
      }
    });

    map.addLayer({
      id:"regions-outline", type:"line", source:"regions",
      paint:{ "line-color":"#333", "line-width":1 }
    });

    map.on("click","regions-fill",(e)=>{
      const p=e.features[0].properties;
      new mapboxgl.Popup().setLngLat(e.lngLat).setHTML(`
        <strong>${p.region}</strong><br/>
        Population: ${fmtNum(p.population)}<br/>
        Strikers: ${fmtNum(p.strikers)}<br/>
        Strike %: ${fmtPercent(p.strike_percent)}<br/>
        Baseline Output: ${fmtNum(p.baseline_output)}<br/>
        Adjusted Output: ${fmtNum(p.adjusted_output)}<br/>
        Wage Demand: ${fmtMoney(p.wage_demand)}<br/>
        Notes: ${p.notes||""}
      `).addTo(map);
    });
  }

  // ---- Legend ----
  const legend=document.getElementById("legend");
  const grades=[0,1,5,10,20,40];
  const colors=["#cccccc","#f4a6a6","#ff9966","#ff3300","#b30000","#660000"];
  grades.forEach((g,i)=>{
    const next=grades[i+1];
    const item=document.createElement("div");
    item.innerHTML=`<span style="background:${colors[i]}"></span>${next?`${g}% – ${next}%`:`${g}%+`}`;
    legend.appendChild(item);
  });

  // ---- Nationwide ----
  if (data.nationwide) {
    legend.innerHTML += `
      <hr/><h5>Nationwide Totals</h5>
      Strikers: ${fmtNum(data.nationwide.strikers)}<br/>
      Strike %: ${fmtPercent(data.nationwide.strike_percent)}<br/>
      Wage Demand: ${fmtMoney(data.nationwide.wage_demand)}
    `;
  }
});
</script>
</body>
</html>
