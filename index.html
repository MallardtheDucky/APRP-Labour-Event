<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Live Labour Strikes Map</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.css" rel="stylesheet"/>
  <style>
    body { margin:0; padding:0; font-family:system-ui,Segoe UI,Roboto,sans-serif; }
    #map { position:absolute; top:220px; bottom:0; width:100%; transition:top 0.3s ease; }
    #header { position:absolute; top:0; left:0; right:0; background:#222; color:white; padding:12px 18px; z-index:1000; display:flex; flex-direction:column; align-items:center; height:220px; overflow:hidden; transition:transform 0.3s ease; }
    .title { font-size:22px; font-weight:700; margin-bottom:8px; text-align:center; }
    .metrics-container{display:flex;flex-wrap:wrap;justify-content:center;gap:28px;max-width:1100px}
    .metric{ text-align:center }
    .metric-label{ font-size:13px; text-transform:uppercase; font-weight:700; color:#ddd }
    .metric-value{ font-size:18px; color:#6ef06e; margin-top:4px }
    .nationwide-container{ display:flex; gap:28px; margin-top:10px; justify-content:center }
    .nationwide-label{ font-size:13px; font-weight:700; color:#ffd57a }
    .nationwide-value{ font-size:16px; color:#ffd57a; margin-top:4px }
    #toggle-header{ position:absolute; bottom:10px; left:50%; transform:translateX(-50%); background:none; border:none; color:white; font-size:22px; cursor:pointer }
    .legend{ position:absolute; bottom:20px; right:20px; background:white; padding:10px; border-radius:6px; font-size:12px }
    .legend div{ margin:3px 0 }
    .legend span{ display:inline-block; width:12px; height:12px; margin-right:6px }
    #refresh { position: absolute; top:10px; right:10px; z-index:1200; padding:6px 10px; border-radius:6px; background:#1e90ff; color:white; border:none; cursor:pointer; }
    .hidden { transform:translateY(-100%); }
    .full { top:0 !important; }
  </style>
</head>
<body>
  <div id="header">
    <div class="title">Live Labour Strikes Map</div>

    <div class="metrics-container">
      <div class="metric"><div class="metric-label">Productivity Growth %</div><div class="metric-value" id="prod">—</div></div>
      <div class="metric"><div class="metric-label">Business Closings %</div><div class="metric-value" id="close">—</div></div>
      <div class="metric"><div class="metric-label">Confidence Index</div><div class="metric-value" id="conf">—</div></div>
      <div class="metric"><div class="metric-label">Inflation %</div><div class="metric-value" id="infl">—</div></div>
      <div class="metric"><div class="metric-label">Wage Growth (avg $)</div><div class="metric-value" id="wage">—</div></div>
    </div>

    <div class="nationwide-container">
      <div class="nationwide"><div class="nationwide-label">Nationwide Strikers</div><div class="nationwide-value" id="nat-strikers">—</div></div>
      <div class="nationwide"><div class="nationwide-label">Strike % of Population</div><div class="nationwide-value" id="nat-percent">—</div></div>
      <div class="nationwide"><div class="nationwide-label">Wage Demand ($)</div><div class="nationwide-value" id="nat-wage">—</div></div>
    </div>

    <button id="toggle-header" title="Toggle header visibility">▲</button>
  </div>

  <button id="refresh" title="Refresh data">Refresh</button>
  <div id="map"></div>

  <div class="legend">
    <div><span style="background:#cccccc"></span>No strikes (0%)</div>
    <div><span style="background:#f2f0a6"></span>Very Low (0–2%)</div>
    <div><span style="background:#f4a6a6"></span>Low (2–5%)</div>
    <div><span style="background:#ff7f50"></span>Medium (5–10%)</div>
    <div><span style="background:#d12c0f"></span>High (10–20%)</div>
    <div><span style="background:#800000"></span>Extreme (20%+)</div>
  </div>

  <script>
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwqcuPynixZTTEq-mTKRhrkseIaeGCfeR2vpkAgH_36g7NCgO-aooMoAy2A7Z_3_IBe/exec";
    mapboxgl.accessToken = "pk.eyJ1IjoiNW00Y2s3NyIsImEiOiJjbWI4eXFqeDkwbzY1MmpwcDFzZDIwMmVqIn0.6JGe7JWhk28z5D3TLIJQwg";

    const map = new mapboxgl.Map({
      container: "map",
      style: "mapbox://styles/mapbox/light-v10",
      center: [-98.5795, 39.8283],
      zoom: 3
    });

    // Format helpers
    function fmtPercent(v){
      if (v === null || v === undefined || v === '') return "0%";
      const num = Number(String(v).replace("%",""));
      return isNaN(num) ? v : num.toFixed(2) + "%";
    }
    function fmtMoney(v){
      if (v === null || v === undefined || v === '') return "$0";
      const num = Number(String(v).replace(/[^0-9.\-]/g,""));
      return isNaN(num) ? v : "$" + Math.round(num).toLocaleString();
    }
    function fmtNumber(v){
      if (v === null || v === undefined || v === '') return "0";
      const num = Number(v);
      return isNaN(num) ? v : num.toLocaleString();
    }
    function fmtDecimal(v, places=2){
      if (v === null || v === undefined || v === '') return "0";
      const num = Number(v);
      return isNaN(num) ? v : num.toFixed(places);
    }

    // Toggle header
    const toggleButton = document.getElementById('toggle-header');
    const header = document.getElementById('header');
    const mapDiv = document.getElementById('map');
    toggleButton.addEventListener('click', () => {
      header.classList.toggle('hidden');
      mapDiv.classList.toggle('full');
      toggleButton.innerHTML = header.classList.contains('hidden') ? '▼' : '▲';
      map.resize();
    });

    // Utility: safe uppercase
    const u = s => (s === null || s === undefined) ? "" : String(s).toString().trim().toUpperCase();

    // Fetch + render
    async function fetchAndRender(){
      // set a visual loading state (optional)
      document.getElementById('nat-strikers').textContent = 'Loading...';
      document.getElementById('nat-percent').textContent = 'Loading...';
      document.getElementById('nat-wage').textContent = 'Loading...';

      try {
        const res = await fetch(APPS_SCRIPT_URL + "?_=" + Date.now());

        // robust JSON parsing: try res.json(), fallback to parsing text
        let data;
        try {
          data = await res.json();
        } catch (err) {
          const txt = await res.text();
          console.warn("Primary JSON parse failed; raw text:", txt);
          try {
            data = JSON.parse(txt);
          } catch(e2) {
            console.error("Failed to parse response as JSON:", e2);
            // show user-friendly fallback
            document.getElementById('nat-strikers').textContent = '—';
            document.getElementById('nat-percent').textContent = '—';
            document.getElementById('nat-wage').textContent = '—';
            return;
          }
        }

        console.log("Fetched API response:", data);

        // ensure geojson exists
        const geojson = (data && data.geojson) ? data.geojson : null;
        if (!geojson || !geojson.features || !Array.isArray(geojson.features)) {
          console.warn("No geojson.features present in response; aborting map render.");
          // but still try to extract nationwide from normalizedData if present
        }

        // Economic metrics (unchanged)
        (data.economicImpact || []).forEach(entry => {
          if (!entry || !entry.metric) return;
          const m = entry.metric.toLowerCase();
          const v = entry.current_value;
          if (m.includes("productivity")) document.getElementById("prod").textContent = fmtPercent(v);
          else if (m.includes("closing")) document.getElementById("close").textContent = fmtPercent(v);
          else if (m.includes("confidence")) document.getElementById("conf").textContent = fmtDecimal(v,2);
          else if (m.includes("inflation")) document.getElementById("infl").textContent = fmtPercent(v);
          else if (m.includes("wage")) document.getElementById("wage").textContent = fmtMoney(v);
        });

        // --- Find nationwide ---
        let nationwide = null;
        const nd = data.normalizedData;

        if (nd !== undefined && nd !== null) {
          if (Array.isArray(nd)) {
            console.log("normalizedData is an array; regions:", nd.map(x => u(x.region)).slice(0,50));
            nationwide = nd.find(r => u(r.region) === "NATIONWIDE");
            if (nationwide) console.log("Found NATIONWIDE in normalizedData (array):", nationwide);
          } else if (typeof nd === "object") {
            console.log("normalizedData is an object:", nd.region ? u(nd.region) : nd);
            if (u(nd.region) === "NATIONWIDE") {
              nationwide = nd;
              console.log("Found NATIONWIDE in normalizedData (object):", nationwide);
            }
          } else {
            console.log("normalizedData present but not array/object:", nd);
          }
        } else {
          console.log("normalizedData not present on response.");
        }

        // Fallback: search geojson.features for a NATIONWIDE properties entry
        if (!nationwide && geojson && Array.isArray(geojson.features)) {
          const foundFeat = geojson.features.find(f => u((f.properties && (f.properties.region || f.properties.name)) || "") === "NATIONWIDE");
          if (foundFeat) {
            nationwide = foundFeat.properties;
            console.log("Found NATIONWIDE in geojson.features:", nationwide);
          } else {
            console.log("No NATIONWIDE in geojson.features.");
          }
        }

        // Final fallback: build an aggregate nationwide from normalizedData or from features
        if (!nationwide) {
          // If normalizedData is an array, aggregate
          if (Array.isArray(nd) && nd.length > 0) {
            const agg = nd.reduce((acc, cur) => {
              const pop = Number(cur.population) || 0;
              const str = Number(cur.strikers) || 0;
              acc.population += pop;
              acc.strikers += str;
              // keep last non-empty wage_demand if present
              if (cur.wage_demand) acc.wage_demand = cur.wage_demand;
              return acc;
            }, { region: 'NATIONWIDE', population:0, strikers:0, wage_demand: null });
            if (agg.population > 0) {
              agg.strike_percent = Math.round((agg.strikers / agg.population) * 10000) / 100; // 2 decimals %
            } else {
              agg.strike_percent = 0;
            }
            // only use the aggregate if it actually collected something
            if (agg.population > 0 || agg.strikers > 0) {
              nationwide = agg;
              console.log("Built aggregate NATIONWIDE from normalizedData:", nationwide);
            }
          }
          // If still not found and geojson.features exist, try aggregating features
          if (!nationwide && geojson && Array.isArray(geojson.features)) {
            const agg2 = geojson.features.reduce((acc, f) => {
              const p = f.properties || {};
              const pop = Number(p.population) || 0;
              const str = Number(p.strikers) || 0;
              acc.population += pop;
              acc.strikers += str;
              if (p.wage_demand) acc.wage_demand = p.wage_demand;
              return acc;
            }, { region: 'NATIONWIDE', population:0, strikers:0, wage_demand: null });
            if (agg2.population > 0 || agg2.strikers > 0) {
              agg2.strike_percent = agg2.population > 0 ? Math.round((agg2.strikers / agg2.population) * 10000) / 100 : 0;
              nationwide = agg2;
              console.log("Built aggregate NATIONWIDE from geojson.features:", nationwide);
            }
          }
        }

        // Inject nationwide values in the UI if present
        if (nationwide) {
          // handle strike_percent being a fraction (0.35) vs percent (35)
          let sp = Number(nationwide.strike_percent);
          if (!isNaN(sp) && sp !== 0 && Math.abs(sp) < 1) sp = sp * 100;
          document.getElementById('nat-strikers').textContent = fmtNumber(nationwide.strikers);
          document.getElementById('nat-percent').textContent = fmtPercent(sp);
          document.getElementById('nat-wage').textContent = fmtMoney(nationwide.wage_demand);
        } else {
          console.warn("Nationwide data not found after all fallbacks.");
          document.getElementById('nat-strikers').textContent = '—';
          document.getElementById('nat-percent').textContent = '—';
          document.getElementById('nat-wage').textContent = '—';
        }

        // --- Normalize region props in geojson.features (for map & popup) ---
        if (geojson && Array.isArray(geojson.features)) {
          geojson.features.forEach(f => {
            if (!f.properties) f.properties = {};
            if (f.properties.region) f.properties.region = f.properties.region.toString().trim().toUpperCase();
            if (f.properties.name) f.properties.name = f.properties.name.toString().trim().toUpperCase();
            if (f.properties.strike_percent !== undefined && f.properties.strike_percent !== null) {
              // leave numeric value as-is; popup/legend will scale display
              f.properties.strike_percent = Number(f.properties.strike_percent);
            }
            if (f.properties.adjusted_output !== undefined && f.properties.adjusted_output !== null) {
              f.properties.adjusted_output = Number(f.properties.adjusted_output);
            }
          });

          // Map source + layers
          if (map.getSource('regions')) {
            map.getSource('regions').setData(geojson);
          } else {
            map.addSource('regions', { type: 'geojson', data: geojson });
            map.addLayer({
              id: 'regions-fill',
              type: 'fill',
              source: 'regions',
              paint: {
                'fill-color': [
                  'interpolate',
                  ['linear'],
                  ['to-number', ['get', 'strike_percent'], 0],
                  0, '#cccccc',
                  2, '#f2f0a6',
                  5, '#f4a6a6',
                  10, '#ff7f50',
                  20, '#d12c0f',
                  40, '#800000'
                ],
                'fill-opacity': 0.8
              }
            });
            map.addLayer({
              id: 'regions-outline',
              type: 'line',
              source: 'regions',
              paint: { 'line-color': '#000', 'line-width': 1 }
            });
          }

          // Popup
          const popup = new mapboxgl.Popup({ closeButton:false, closeOnClick:false });
          map.on('mousemove', 'regions-fill', e => {
            if (!e.features || !e.features[0]) return;
            const p = e.features[0].properties || {};
            // adjust percent for display (if provided as fraction)
            let psp = p.strike_percent;
            if (psp !== undefined && psp !== null && Math.abs(Number(psp)) < 1) psp = Number(psp) * 100;
            popup.setLngLat(e.lngLat)
              .setHTML(`
                <strong>${p.region || p.name || "REGION"}</strong><br/>
                <b>Strikers:</b> ${fmtNumber(p.strikers)}<br/>
                <b>Strike % of Population:</b> ${fmtPercent(psp)}<br/>
                <b>Adjusted Output:</b> ${fmtDecimal(p.adjusted_output,2)}<br/>
                <b>Wage Demand ($):</b> ${fmtMoney(p.wage_demand)}<br/>
                <b>Notes:</b> ${p.notes ?? "None"}
              `).addTo(map);
          });
          map.on('mouseleave','regions-fill',()=>popup.remove());
        }

      } catch(err){
        console.error("Fetch/render failed:", err);
        document.getElementById('nat-strikers').textContent = '—';
        document.getElementById('nat-percent').textContent = '—';
        document.getElementById('nat-wage').textContent = '—';
      }
    }

    document.getElementById('refresh').addEventListener('click', fetchAndRender);
    map.on('load', fetchAndRender);
  </script>
</body>
</html>
