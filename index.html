<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Live Labour Strikes Map</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.css" rel="stylesheet"/>
  <style>
    body { margin:0; padding:0; font-family:Arial, sans-serif; }
    #map { position:absolute; top:0; bottom:0; width:100%; }
    #metrics {
      position:absolute;
      top:10px; left:10px;
      background:white; padding:10px;
      border-radius:6px;
      box-shadow:0 0 5px rgba(0,0,0,0.3);
      font-size:13px;
      z-index:1;
    }
    #metrics div { margin:3px 0; }
    .legend {
      background: white;
      padding: 8px;
      font-family: Arial, sans-serif;
      font-size: 12px;
      position: absolute;
      bottom: 20px;
      left: 20px;
      border-radius: 6px;
      box-shadow: 0 0 4px rgba(0,0,0,0.3);
    }
    .legend h4 { margin: 0 0 4px; font-size: 14px; }
    .legend div { margin: 2px 0; }
    .legend span {
      display: inline-block;
      width: 14px;
      height: 14px;
      margin-right: 4px;
      vertical-align: middle;
    }
  </style>
</head>
<body>
<div id="map"></div>
<div id="metrics"></div>
<div class="legend" id="legend">
  <h4>Strike % of Population</h4>
</div>
<script>
mapboxgl.accessToken = "YOUR_MAPBOX_TOKEN_HERE"; // replace with Mapbox token

const map = new mapboxgl.Map({
  container: "map",
  style: "mapbox://styles/mapbox/light-v11",
  center: [-98, 39],
  zoom: 3
});

// ---- Formatters ----
function fmtNum(v) {
  if (v === null || v === undefined || v === '') return '0';
  return Number(v).toLocaleString();
}

function fmtPercent(v) {
  if (v === null || v === undefined || v === '') return '0%';
  const num = Number(v);
  if (isNaN(num)) return String(v);
  return num.toFixed(2) + '%';
}

function fmtMoney(v) {
  if (v === null || v === undefined || v === '') return '$0';
  return '$' + Number(v).toLocaleString();
}

// ---- Load data ----
async function loadData() {
  const url = "https://script.google.com/macros/s/AKfycbzSlHgv07HZhfwwXwjkmNpP-4YfY3UNfQzzMojmJg7gHc_WdloJ7bRIp2OcdZPrDJNfKw/exec";
  const resp = await fetch(url);
  if (!resp.ok) {
    console.error("Failed to fetch data:", resp.status, resp.statusText);
    return null;
  }
  return await resp.json();
}

map.on("load", async () => {
  const data = await loadData();
  if (!data || !data.geojson) {
    alert("Failed to load strike data.");
    return;
  }

  // ---- Economic metrics ----
  if (data.economicImpact) {
    const mDiv = document.getElementById("metrics");
    mDiv.innerHTML = "";
    data.economicImpact.forEach(m => {
      let val = m.current_value;
      const label = m.metric;
      if (/wage/i.test(label)) val = fmtMoney(val);
      else if (/%|growth|inflation|closing|productivity/i.test(label)) val = fmtPercent(val);
      else val = Number(val).toLocaleString();
      const line = document.createElement("div");
      line.innerHTML = `<strong>${label}</strong>: ${val}`;
      mDiv.appendChild(line);
    });
  }

  // ---- Map layers ----
  map.addSource("regions", {
    type: "geojson",
    data: data.geojson
  });

  map.addLayer({
    id: "regions-fill",
    type: "fill",
    source: "regions",
    paint: {
      "fill-color": [
        "interpolate",
        ["linear"],
        ["to-number", ["get", "strike_percent"], 0],
        0, "#cccccc",
        1, "#f4a6a6",
        5, "#ff9966",
        10, "#ff3300",
        20, "#b30000",
        40, "#660000"
      ],
      "fill-opacity": 0.7
    }
  });

  map.addLayer({
    id: "regions-outline",
    type: "line",
    source: "regions",
    paint: { "line-color": "#333", "line-width": 1 }
  });

  // ---- Popup ----
  map.on("click", "regions-fill", (e) => {
    const p = e.features[0].properties;
    const html = `
      <strong>${p.region}</strong><br/>
      Population: ${fmtNum(p.population)}<br/>
      Strikers: ${fmtNum(p.strikers)}<br/>
      Strike %: ${fmtPercent(p.strike_percent)}<br/>
      Baseline Output: ${fmtNum(p.baseline_output)}<br/>
      Adjusted Output: ${fmtNum(p.adjusted_output)}<br/>
      Wage Demand: ${fmtMoney(p.wage_demand)}<br/>
      Notes: ${p.notes || ""}
    `;
    new mapboxgl.Popup().setLngLat(e.lngLat).setHTML(html).addTo(map);
  });

  // ---- Legend ----
  const legend = document.getElementById("legend");
  const grades = [0, 1, 5, 10, 20, 40];
  const colors = ["#cccccc","#f4a6a6","#ff9966","#ff3300","#b30000","#660000"];
  grades.forEach((grade, i) => {
    const next = grades[i + 1];
    const color = colors[i];
    const label = next ? `${grade}% â€“ ${next}%` : `${grade}%+`;
    const item = document.createElement("div");
    const key = document.createElement("span");
    key.style.backgroundColor = color;
    item.appendChild(key);
    item.appendChild(document.createTextNode(label));
    legend.appendChild(item);
  });

  // ---- Nationwide ----
  if (data.nationwide) {
    const nw = data.nationwide;
    const nwDiv = document.createElement("div");
    nwDiv.innerHTML = `
      <hr/>
      <strong>Nationwide</strong><br/>
      Strikers: ${fmtNum(nw.strikers)}<br/>
      Strike %: ${fmtPercent(nw.strike_percent)}<br/>
      Wage Demand: ${fmtMoney(nw.wage_demand)}
    `;
    legend.appendChild(nwDiv);
  }
});
</script>
</body>
</html>
