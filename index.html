<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Live Labour Strikes Map</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.css" rel="stylesheet"/>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
    }
    #map {
      position: absolute;
      top: 200px;
      bottom: 0;
      width: 100%;
      transition: top 0.3s ease;
    }
    #header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      background: #222;
      color: white;
      padding: 15px 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 200px;
      overflow: hidden;
      transition: transform 0.3s ease;
    }
    #header.hidden {
      transform: translateY(-100%);
    }
    #map.full {
      top: 0;
    }
    .title {
      font-size: 26px;
      font-weight: bold;
      margin-bottom: 10px;
      text-align: center;
    }
    .metrics-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 25px;
      max-width: 1000px;
    }
    .metric-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 150px;
    }
    .metric-label {
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 5px;
      text-transform: uppercase;
    }
    .metric-value {
      font-size: 18px;
      color: #00e676;
    }
    #toggle-header {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      transition: transform 0.3s ease;
    }
    #toggle-header.up {
      transform: translateX(-50%) rotate(180deg);
    }
    #toggle-header-map {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      padding: 5px 10px;
      border-radius: 5px;
      z-index: 1000;
      display: none;
      transition: transform 0.3s ease;
    }
    #toggle-header-map.down {
      transform: translateX(-50%) rotate(180deg);
    }
    #header.hidden + #map #toggle-header-map {
      display: block;
    }
  </style>
</head>
<body>
  <div id="header">
    <div class="title">Live Labour Strikes Map</div>
    <div class="metrics-container" id="metrics">
      <!-- Metrics will be populated here -->
    </div>
    <button id="toggle-header" title="Toggle header visibility">▲</button>
  </div>

  <div id="map">
    <button id="toggle-header-map" title="Toggle header visibility">▼</button>
  </div>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiNW00Y2s3NyIsImEiOiJjbWI4eXFqeDkwbzY1MmpwcDFzZDIwMmVqIn0.6JGe7JWhk28z5D3TLIJQwg';

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/light-v10',
      center: [-98.5795, 39.8283],
      zoom: 3
    });

    const header = document.getElementById('header');
    const mapDiv = document.getElementById('map');
    const toggleButton = document.getElementById('toggle-header');
    const toggleButtonMap = document.getElementById('toggle-header-map');

    function toggleHeader() {
      header.classList.toggle('hidden');
      mapDiv.classList.toggle('full');
      toggleButton.classList.toggle('up');
      toggleButtonMap.classList.toggle('down');
      toggleButton.innerHTML = header.classList.contains('hidden') ? '▼' : '▲';
      toggleButtonMap.innerHTML = header.classList.contains('hidden') ? '▼' : '▲';
      map.resize();
    }

    toggleButton.addEventListener('click', toggleHeader);
    toggleButtonMap.addEventListener('click', toggleHeader);

    map.on('load', async () => {
      try {
        const res = await fetch('https://script.google.com/macros/s/AKfycbyn624xZ7IYDVEbToe2Hu6Mu_8Pnv8Z6oHk0lVWnxaSGn4VGyP2-6novLJ9Ky065J06Gg/exec');
        if (!res.ok) throw new Error(`Fetch failed with status ${res.status}`);
        const data = await res.json();
        console.log("Fetched Data:", data);

        if (data.error) throw new Error(`Apps Script error: ${data.error}`);

        // Split into strikes vs economic metrics
        const strikeFeatures = data.features.filter(f => f.properties.sheet === "StrikeTracker");
        const econFeatures = data.features.filter(f => f.properties.sheet === "ECONOMIC IMPACT");

        // Populate Metrics in Header
        const metricsDiv = document.getElementById("metrics");
        econFeatures.forEach(f => {
          const m = f.properties;
          const div = document.createElement("div");
          div.className = "metric-group";
          div.innerHTML = `
            <div class="metric-label">${m.metric}</div>
            <div class="metric-value">${m.current_value}</div>
          `;
          metricsDiv.appendChild(div);
        });

        // Add strike regions as source
        map.addSource('regions', { type: 'geojson', data: { type: "FeatureCollection", features: strikeFeatures } });

        map.addLayer({
          id: 'regions-fill',
          type: 'fill',
          source: 'regions',
          paint: {
            'fill-color': [
              'interpolate',
              ['linear'],
              ['to-number', ['get', 'strike_percent'], 0],
              0, '#cccccc',
              5, '#f4a6a6',
              15, '#d12c0f'
            ],
            'fill-opacity': 0.8
          }
        });

        map.addLayer({
          id: 'regions-outline',
          type: 'line',
          source: 'regions',
          paint: { 'line-color': '#000000', 'line-width': 1 }
        });

        // Popup on hover
        map.on('mousemove', 'regions-fill', (e) => {
          const p = e.features[0].properties;
          const popupContent = `
            <strong>${p.region}</strong><br/>
            <b>Strikers:</b> ${p.strikers}<br/>
            <b>Strike % of Population:</b> ${p.strike_percent}%<br/>
            <b>Adjusted Output:</b> ${p.adjusted_output}<br/>
            <b>Wage Demand ($):</b> ${p.wage_demand}<br/>
            <b>Notes:</b> ${p.notes || "None"}
          `;
          new mapboxgl.Popup({ closeButton: false })
            .setLngLat(e.lngLat)
            .setHTML(popupContent)
            .addTo(map);
        });

        map.on('mouseleave', 'regions-fill', () => {
          const popups = document.getElementsByClassName("mapboxgl-popup");
          if (popups.length) popups[0].remove();
        });

      } catch (err) {
        console.error("Map load error:", err);
        document.getElementById('map').innerHTML = `<p style="color:red;text-align:center;">Map failed to load: ${err.message}</p>`;
      }
    });
  </script>
</body>
</html>
